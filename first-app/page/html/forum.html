<!DOCTYPE html>
<html>
<head>
  <title>留言板</title>
  <style>
    body {
      background-color: #6B3E9C;
      color: #FFFFFF;
      font-family: Arial, sans-serif;
    }

    #message-form {
      margin-bottom: 20px;
    }

    #message-form input,
    #message-form textarea {
      display: block;
      margin-bottom: 10px;
      width: 300px;
    }

    #message-form button {
      background-color: #FF2300;
      color: #FFFFFF;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
    }

    #message-form button:hover {
      background-color: #FEDF00;
    }

    .message {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #FFFFFF;
      color: #000000;
    }

    .message-content {
      margin-bottom: 10px;
    }

    .reply-form {
      margin-left: 20px;
    }

    .reply-form input,
    .reply-form textarea {
      display: block;
      margin-bottom: 10px;
      width: 250px;
    }

    .reply-form button {
      background-color: #0096C9;
      color: #FFFFFF;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
    }

    .reply-form button:hover {
      background-color: #FEDF00;
    }
  </style>
</head>
<body>
  <h1>留言板</h1>

  <form id="message-form" enctype="multipart/form-data">
    <h2>發布留言</h2>
    <input type="text" id="name-input" placeholder="姓名" name="name">
    <textarea id="message-input" placeholder="留言內容" name="message"></textarea>
    <input type="file" id="image-input" name="photos">
    <button type="submit" id="send-button">發布</button>
  </form>

  <div id="messages"></div>

  <script>
    const messageForm = document.getElementById('message-form');
    const nameInput = document.getElementById('name-input');
    const messageInput = document.getElementById('message-input');
    const imageInput = document.getElementById('image-input');
    const messagesDiv = document.getElementById('messages');

    // 发布留言
    messageForm.addEventListener('submit', (event) => {
      event.preventDefault();

      const name = nameInput.value;
      const message = messageInput.value;

      if (name && message) {
        const formData = new FormData(messageForm);
        // formData.append('name', name);
        // formData.append('message', message);

        // 检查是否有选择图片
        // if (imageInput.files.length > 0) {
        //   const imageFile = imageInput.files[0];
        //   console.log('imageFile', imageFile)
        //   formData.append('photos', imageFile);
        // }
        // const requestBody = {};
        // // 將表單資訊轉換為 JSON 物件
        // for (const [key, value] of formData.entries()) {
        //     console.log(`${key}:${value}`)
        //     requestBody[key] = value;
        // }
        // /forum/messages
        fetch('/forum/messages', {
          method: 'POST',
          headers: {
            // 'Content-Type': 'application/json'
            // 'Content-Type': 'multipart/form-data; boundary=' + formData._boundary
          },
        //   body: JSON.stringify(Object.fromEntries(formData))
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // 清除表单内容
          nameInput.value = '';
          messageInput.value = '';
          imageInput.value = '';

          // 添加新留言到留言板
          displayMessage(data);
        })
        .catch(error => {
          console.error('Error posting message:', error);
        });
      }
    });
    
  function arrayBufferToBase64( buffer ) {
    var binary = '';
    var bytes = new Uint8Array( buffer );
    var len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
      binary += String.fromCharCode( bytes[ i ] );
    }
    return window.btoa( binary );
  }
    // 获取并显示所有留言
    function getMessages() {
      fetch('/forum/messages')
        .then(response => response.json())
        .then(data => {
          // 清空留言板
          messagesDiv.innerHTML = '';
          window.globalMsg = data;
          // 显示每个留言
          data.forEach(message => {
            if (message.message) {
              displayMessage(message);
            }
          });
        })
        .catch(error => {
          console.error('Error fetching messages:', error);
        });
    }

    // 在留言板上显示留言
    function displayMessage(message) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      messageElement.dataset.messageId = message.key;

      const nameElement = document.createElement('h3');
      nameElement.textContent = message.name;

      const contentElement = document.createElement('p');
      contentElement.className = 'message-content';
      contentElement.textContent = message.message;

      messageElement.appendChild(nameElement);
      messageElement.appendChild(contentElement);

      // 如果有图片，显示图片
      if (message.image) {
        const imgItem = window.globalMsg.find((item) => {
          if (message.image === item.key) {
            return true;
          }
          return false;
        })
        if (imgItem) {
          const imageElement = document.createElement('img');
          imageElement.src = arrayBufferToBase64(imgItem.value.data);
          imageElement.style.maxWidth = '200px';
          imageElement.style.marginTop = '10px';
          messageElement.appendChild(imageElement);
        }
      }

      // 添加回复表单
      const replyForm = createReplyForm(message.key);
      messageElement.appendChild(replyForm);

      messagesDiv.appendChild(messageElement);
      if (message && message.replies) {
        message.replies.forEach((reply) => {
          displayReply(message.key, reply)
        })
      }
    }

    // 创建回复表单
    function createReplyForm(messageId) {
      const replyForm = document.createElement('form');
      replyForm.className = 'reply-form';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = '姓名';
      nameInput.name = 'name';
      replyForm.appendChild(nameInput);

      const messageInput = document.createElement('textarea');
      messageInput.placeholder = '回覆內容';
      messageInput.name = 'message';
      replyForm.appendChild(messageInput);

      const replyButton = document.createElement('button');
      replyButton.textContent = '回覆';
      replyForm.appendChild(replyButton);

      // 回复留言
      replyButton.addEventListener('click', (event) => {
        event.preventDefault();
        const name = nameInput.value;
        const message = messageInput.value;

        if (name && message) {
          const formData = new FormData(replyForm);
          // formData.append('name', name);
          // formData.append('message', message);

          fetch(`/forum/messages/${messageId}/reply`, {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            // 清除回复表单内容
            nameInput.value = '';
            messageInput.value = '';

            // 显示回复
            displayReply(messageId, data);
          })
          .catch(error => {
            console.error('Error posting reply:', error);
          });
        }
      });

      return replyForm;
    }

    // 在指定留言下显示回复
    function displayReply(messageId, reply) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);

      if (messageElement) {
        const replyElement = document.createElement('div');
        replyElement.className = 'reply';

        const nameElement = document.createElement('strong');
        nameElement.textContent = reply.name;

        const contentElement = document.createElement('p');
        contentElement.textContent = reply.message;

        replyElement.appendChild(nameElement);
        replyElement.appendChild(contentElement);

        messageElement.appendChild(replyElement);
      }
    }

    // 初始化留言板
    getMessages();
  </script>
</body>
</html>